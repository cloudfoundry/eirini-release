#!/bin/bash -e

run_dir=/var/vcap/sys/run/cube_stager
log_dir=/var/vcap/sys/log/cube_stager
conf_dir=/var/vcap/jobs/cube_stager/config
pidfile=$run_dir/cube_stager.pid

echo $$ > $pidfile

exec /var/vcap/packages/cube/bin/cube stage  \
  --kubeconfig "$conf_dir/kube.yml" \
  --cf-endpoint <%= p('cube_stager.ccAPI') %> \
  --cf-username <%= p('cube_stager.adminUser') %> \
  --cf-password <%= p('cube_stager.adminPassword') %> \
  --cube-address <%= p('cube_stager.cube_address') %> \
  --namespace <%= p('cube_stager.kube_namespace') %> \
  <% if p("cube_stager.skipSslValidation") %>--skipSslValidation<% end %> \
  2> >(tee -a $log_dir/cube_stager.stderr.log | logger -p user.error -t vcap.stager) \
  1> >(tee -a $log_dir/cube_stager.stdout.log | logger -t vcap.stager)
